version: '3.7'
services:
  website:
    build:
      context: .
      dockerfile: website/Dockerfile.dev
    volumes:
      - ~/.cache/yarn:/home/node/.cache/yarn
      - ./website:/home/node/app/website
      - ./packages:/home/node/app/packages
      - ./.prettierrc.js:/home/node/app/.prettierrc.js
    expose:
      - '8080'
      - '8081'
    environment:
      - NODE_ENV=development
      - PORT=8080
      - HOST=0.0.0.0
      - DATA_API_BASE_URL=/api
      - GIT_COMMIT_HASH=DEVELOP # Use docker-compose up GIT_COMMIT_HASH=$(git rev-parse HEAD) in prod
    user: ${CURRENT_UID:-1000:1000}
    restart: on-failure
  export:
    build:
      context: .
      dockerfile: export/Dockerfile.dev
    volumes:
      - ~/.cache/yarn:/home/node/.cache/yarn
      - ./export:/home/node/app/export
      - ./.prettierrc.js:/home/node/app/.prettierrc.js
    expose:
      - '8082'
    depends_on:
      - website
    security_opt:
      - seccomp="infrastructure/chromium.seccomp.json"
    environment:
      - NODE_ENV=development
      - PORT=8082
      - HOST=0.0.0.0
    user: ${CURRENT_UID:-1000:1000}
    restart: on-failure
  proxy:
    image: abiosoft/caddy:no-stats
    ports:
      - '8080:8080'
    volumes:
      - ./infrastructure/Caddyfile:/etc/Caddyfile
      - ./infrastructure/logs:/logs
    restart: on-failure
